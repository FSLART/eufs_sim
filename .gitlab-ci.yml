image: ros:foxy-ros-base-focal

variables:
  GIT_CLONE_PATH: $CI_BUILDS_DIR/$CI_CONCURRENT_PROJECT_ID/ros_ws/src/eufs_sim
  GIT_SUBMODULE_STRATEGY: recursive

before_script:
  # Gives us access to other private repos
  - "command -v ssh-agent >/dev/null || ( apt-get update -qq -y && apt-get install openssh-client -qq -y )"
  - eval $(ssh-agent -s)
  - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
  - mkdir -p ~/.ssh
  - chmod 700 ~/.ssh
  - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config

  # Configure git user to be able to use git commands
  - git config --global user.email "eufs@eufs.com"
  - git config --global user.name "eufs"

  # Move out of GIT_CLONE_PATH
  - cd $CI_BUILDS_DIR/$CI_CONCURRENT_PROJECT_ID/ros_ws

  # Clone eufs_msgs
  - rm -rf src/eufs_msgs
  - git -C src clone -b ros2 git@gitlab.com:eufs/eufs_msgs.git

  # Install ROS package dependencies
  - apt-get update -qq
  - rosdep update -q
  - rosdep install -yq --from-paths src --ignore-src
  - rm -rf /var/lib/apt/lists/*

  # Source ROS
  - . /opt/ros/$ROS_DISTRO/setup.sh

  # Build eufs_msgs
  - colcon build --packages-select eufs_msgs
  - . install/setup.sh

# stages
stages:
  - test

colcon:
  stage: test
  script:
    - colcon build
  # Only run on ros2 branch and merge requests
  rules:
    - if: $CI_MERGE_REQUEST_ID
    - if: $CI_COMMIT_BRANCH == "ros2"
